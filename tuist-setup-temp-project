#!/bin/bash
set -euo pipefail

# Generate random strings for org and project names
ORG_NAME="org-$(openssl rand -hex 4)"
PROJECT_NAME="project-$(openssl rand -hex 4)"

echo "Creating temporary organization: $ORG_NAME"
TUIST_URL="https://staging.tuist.dev" tuist organization create "$ORG_NAME" --verbose

echo "Creating temporary project: $ORG_NAME/$PROJECT_NAME"
TUIST_URL="https://staging.tuist.dev" tuist project create "$ORG_NAME/$PROJECT_NAME"

# Save the original Tuist.swift
cp Tuist.swift Tuist.swift.original

# Create new Tuist.swift with temporary project
cat > Tuist.swift << EOF
import ProjectDescription

let tuist = Tuist(
    fullHandle: "$ORG_NAME/$PROJECT_NAME",
    url: "https://staging.tuist.dev",
    project: .xcode()
)
EOF

# Export variables for cleanup
echo "$ORG_NAME" > .tuist-temp-org
echo "$PROJECT_NAME" > .tuist-temp-project
